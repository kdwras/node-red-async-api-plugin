<script type="text/javascript">
    RED.nodes.registerType('async-api-red', {
        category: 'network',
        color: 'rgb(136 81 251)',
        defaults: {
            name: {value: ""}
        },
        inputs: 1,
        outputs: 1,
        icon: "white-globe.svg",
        label: () => {
            return this.name || "AsyncApi-red";
        },
        oneditprepare: () => {
            const node = this;

            // Fetch saved file
            getFile(node.id);

            // Handle file input selection
            $("#node-input-file").on("change", (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadFile(node.id, file);
                }
            });
        }
    });

    /** Function to fetch saved file */
    function getFile(nodeId) {
        $.ajax({
            url: `/async-api-red/${nodeId}/file`,
            type: "GET",
            success: function (response) {
                console.log("File loaded:", response.fileName);

                let fileContent = response.fileContent;
                let blob = new Blob([fileContent], {type: "text/plain"});
                let file = new File([blob], response.fileName, {type: response.fileType});
                let dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);

                $("#node-input-file")[0].files = dataTransfer.files;

                // Fetch related information
                getData(nodeId);
            },
            error: function (err) {
                console.error("Error fetching file:", err);
            }
        });
    }

    /** Function to upload file */
    function uploadFile(nodeId, file) {
        const formData = new FormData();
        formData.append("file", file);

        $.ajax({
            url: `/async-api-red/${nodeId}/file`,
            type: "POST",
            data: formData,
            processData: false, // Prevent jQuery from processing data
            contentType: false, // Let browser set correct Content-Type
            success: function (response) {
                console.log("File uploaded:", response);
                // Fetch updated information after file upload
                getData(nodeId);
            },
            error: function () {
                alert("File upload failed");
            }
        });
    }

    /** Function to fetch servers */
    function getData(nodeId) {
        $.ajax({
            type: "GET",
            url: `/async-api-red/${nodeId}/data`,
            success: function (response) {
                let serverDropdown = $("#node-input-select-server");
                serverDropdown.empty();
                if (response.servers) {
                    response.servers.forEach(server => {
                        serverDropdown.append(
                            `<option value="${server.url}">${server.url}</option>`
                        );
                    });
                }
                let channelDropdown = $("#node-input-channel");
                channelDropdown.empty();
                const channels = response.channels;
                if (channels) {
                    response.channels.forEach(channel => {
                        channelDropdown.append(
                            `<option value="${channel.address}">${channel.address}</option>`
                        );
                        if (channel.operations) {
                            let operationDropdown = $("#node-input-operations");
                            operationDropdown.empty();
                            channel.operations.forEach(operation => {
                                console.log(operation);
                                operationDropdown.append(
                                    `<option value="${operation.id}">${operation.id}</option>`
                                );
                            });
                        }
                    });
                }
            },
            error: function (err) {
                console.error("Error fetching servers:", err);
            }
        });
    }

    function saveUserSelections(nodeId, data) {
        $.ajax({
            url: `/async-api-red/${nodeId}/user-selections`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {
                console.log(response.message);
            },
            error: function (err) {
                console.error("Error saving data:", err);
            }
        });
    }

    function getUserSelections(nodeId){
        $.ajax({
            url: `/async-api-red/${nodeId}/user-selections`,
            type: "GET",
            success: function (data) {
                console.log("Retrieved Data:", data);
            },
            error: function (err) {
                console.error("Error fetching data:", err);
            }
        });
    }

</script>

<script type="text/html" data-template-name="async-api-red">

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-file"><i class="fa fa-file"></i>AsyncAPI File</label>
        <input type="file" id="node-input-file">
        <input type="hidden" id="node-input-fileContent"/>
    </div>

    <div class="form-row">
        <label for="node-input-select-server"><i class="fa fa-server"></i>Server</label>
        <select id="node-input-select-server"></select>
    </div>

    <div class="form-row">
        <label for="node-input-channel"><i class="fa fa-comments"></i>Topic</label>
        <select id="node-input-channel"></select>
    </div>

    <div class="form-row">
        <label><i class="fa fa-list"></i> Operations</label>
        <select id="node-input-operations"></select>
    </div>

</script>

<script type="text/html" data-help-name="async-api-red">
    <p>Parse AsyncAPI descriptions to nodered-ui</p>
</script>
