<script type="text/javascript">
    RED.nodes.registerType('async-api-red', {
        category: 'network',
        color: 'rgb(136 81 251)',
        defaults: {
            name: {value: ""}
        },
        inputs: 1,
        outputs: 1,
        icon: "white-globe.svg",
        label: function () {
            return this.name || "AsyncApi-red";
        },
        oneditprepare: function () {

            const node = this;

            if (node?.id) {
                // Fetch saved file
                getFile(node.id);
            }

            // Handle file input selection
            $("#node-input-file").on("change", (event) => {
                const file = event.target.files[0];
                if (file && node?.id) {
                    uploadFile(node.id, file);
                }
            });

        },
        oneditsave: function () {
            const node = this;
            if (node?.id) {
                const data = {
                    serverUrl: document.getElementById("node-input-select-server").value,
                    topic: document.getElementById("node-input-channel").value
                }
                saveUserSelections(node.id, data);
                connectToServer(node.id);
            }
        },
        // oneditcancel: function () {
        //     const node = this;
        //     node.editor.destroy();
        //     delete node.editor;
        // },
    });

    /** Function to fetch saved file */
    function getFile(nodeId) {
        $.ajax({
            url: `/async-api-red/${nodeId}/file`,
            type: "GET",
            success: function (response) {
                console.log("File loaded:", response.fileName);

                let fileContent = response.fileContent;
                let blob = new Blob([fileContent], {type: "text/plain"});
                let file = new File([blob], response.fileName, {type: response.fileType});
                let dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);

                $("#node-input-file")[0].files = dataTransfer.files;

                // Fetch related information
                getData(nodeId);
            },
            error: function (err) {
                console.error("Error fetching file:", err);
            }
        });
    }

    /** Function to upload file */
    function uploadFile(nodeId, file) {
        const formData = new FormData();
        formData.append("file", file);

        $.ajax({
            url: `/async-api-red/${nodeId}/file`,
            type: "POST",
            data: formData,
            processData: false, // Prevent jQuery from processing data
            contentType: false, // Let browser set correct Content-Type
            success: function (response) {
                console.log("File uploaded:", response);
                // Fetch updated information after file upload
                getData(nodeId);
            },
            error: function () {
                alert("File upload failed");
            }
        });
    }

    /** Function to fetch servers */
    function getData(nodeId) {
        $.ajax({
            type: "GET",
            url: `/async-api-red/${nodeId}/data`,
            success: function (response) {
                let serverDropdown = $("#node-input-select-server");
                let channelDropdown = $("#node-input-channel");
                let operationDropdown = $("#node-input-operations");

                serverDropdown.empty();
                channelDropdown.empty();
                operationDropdown.empty();

                // Populate servers
                if (response.servers) {
                    response.servers.forEach(server => {
                        serverDropdown.append(
                            `<option value="${server.url}">${server.url}</option>`
                        );
                    });
                }

                // Save channels for later use
                const channels = response.channels || [];

                // Populate channels dropdown
                channels.forEach(channel => {
                    channelDropdown.append(
                        `<option value="${channel.address}">${channel.address}</option>`
                    );
                });

                // Bind event to load operations based on selected channel
                channelDropdown.off("change").on("change", function () {
                    const selectedChannelAddress = $(this).val();
                    operationDropdown.empty();

                    const selectedChannel = channels.find(
                        ch => ch.address === selectedChannelAddress
                    );

                    if (selectedChannel && selectedChannel.operations) {
                        selectedChannel.operations.forEach(operation => {
                            operationDropdown.append(
                                `<option value="${operation.id}">${operation.id}</option>`
                            );
                        });
                    }
                });

                //  trigger change event if you want to auto-load operations for the first channel
                channelDropdown.trigger("change");

                operationDropdown.off("change").on("change", function () {
                    const selectedChannelAddress = $("#node-input-channel").val();
                    const selectedOperationId = $(this).val();

                    const selectedChannel = channels.find(
                        ch => ch.address === selectedChannelAddress
                    );

                    const selectedOperation = selectedChannel?.operations?.find(
                        op => op.id === selectedOperationId
                    );

                    renderMessages(selectedChannel, selectedOperation);

                });

                operationDropdown.trigger("change");

                // Save current selections
                const data = {
                    serverUrl: serverDropdown.val(),
                    topic: channelDropdown.val()
                };
                saveUserSelections(nodeId, data);
            },
            error: function (err) {
                console.error("Error fetching servers:", err);
            }
        });
    }

    function saveUserSelections(nodeId, data) {
        $.ajax({
            url: `/async-api-red/${nodeId}/user-selections`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {

            },
            error: function (err) {
            }
        });
    }

    function connectToServer(nodeId) {
        $.ajax({
            url: `/async-api-red/${nodeId}/server-connect`,
            type: "GET",
            contentType: "application/json",
            success: function (response) {
                console.log('connected to server');
            },
            error: function (err) {
            }
        });
    }

    function renderMessages(selectedChannel, selectedOperation) {
        const messages = selectedOperation.messages;

        const container = $("#node-messages-display");
        container.empty();

        if (!messages.length) {
            container.append("<div>No messages available for this operation.</div>");
            return;
        }

        messages.forEach((message, index) => {
            const prettyPayload = JSON.stringify(message.payload, null, 2);
            const html = `
            <div style="margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                <strong>${index + 1}. ${message.name}</strong><br/>
                <em>Summary:</em> ${selectedOperation.summary}<br/>
                <em>Topic:</em> ${selectedChannel.address}<span style=" display: inline-block;
                                                            color: #e1f5fe;
                                                            background-color: #0277bd;
                                                            border-radius: 10px;
                                                            font-size: 11px;
                                                            font-weight: bold;
                                                            padding: 2px 8px;
                                                            margin-left: 8px;
                                                            text-transform: uppercase;">${selectedOperation.action === 'send' ? 'Publish' : 'Subscribe'}</span><br/>
                <em>Operation:</em> ${selectedOperation.id}<br/>
                <em>Content Type:</em> ${message.contentType}<br/>
                <pre>${prettyPayload}</pre>
            </div>
        `;
            container.append(html);
        });
    }

</script>

<script type="text/html" data-template-name="async-api-red">

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-file"><i class="fa fa-file"></i>AsyncAPI File</label>
        <input type="file" id="node-input-file">
        <input type="hidden" id="node-input-fileContent"/>
    </div>

    <div class="form-row">
        <label for="node-input-select-server"><i class="fa fa-server"></i>Server</label>
        <select id="node-input-select-server"></select>
    </div>

    <div class="form-row">
        <label for="node-input-channel"><i class="fa fa-comments"></i>Topic</label>
        <select id="node-input-channel"></select>
    </div>

    <div class="form-row">
        <label><i class="fa fa-list"></i>Operations</label>
        <select id="node-input-operations"></select>
    </div>

    <div class="form-row">
        <label><i class="fa fa-envelope"></i>Message</label>
        <div id="node-messages-display"
             style="background: #f5f5f5;
             padding: 10px;
             max-height: 300px;
             overflow-y: auto;
             font-family: monospace;
             font-size: 12px;">
        </div>
    </div>


</script>

<script type="text/html" data-help-name="async-api-red">
    <p>Parse AsyncAPI descriptions to nodered-ui</p>
</script>
